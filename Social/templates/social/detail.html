{% load social_share %}
{% post_to_telegram 'look at this ' post 'share on telegram' %}
{% post_to_twitter 'look at this ' post 'share on twitter' %}
<div class="post" data-post-id="{{ post.id }}">
    {% if post.photo %}
        <img src="{{ post.photo.url }}">
    {% endif %}
    <br>
    <p style="color: coral">{{ post.caption | linebreaks }}</p>
    <p>published at {{ post.created }}</p>
    <p>by: {{ post.author }}</p>

    <button class="like-button">
        {% if request.user in post.likes.all %}
        	Unlike
        {% else %}
            Like
        {% endif %}
    </button>
    <span class="like-count">{{ like_count }}</span> likes

    <button class="save-post">
        {% if user in post.saved_by.all %}
            UnSave
        {% else %}
            Save
        {% endif %}
    </button>
</div>

{% for tag in post.tags.all %}
    <a href="{% url 'Social:post_list_by_tag' tag %}">{{ tag }}</a>
{% endfor %}
<hr>
<h3>comments: </h3>
<div class="comment-list">
    {% for cm in post.comments.all %}
        <p style="background: lightseagreen; color: indigo">
            {{ cm.author }}: {{ cm.text }}
        </p>
    {% endfor %}
</div>

<h3>Add Comment</h3>
<form class="comment-form" method="post" action="{% url 'Social:comment' %}">
    {% csrf_token %}
    {{ form.as_p }}
    <input type="hidden" name="post_id" value="{{ post.id }}">
    <button type="submit">Add Comment</button>
</form>

<div class="comment-errors" style="color: red;"></div>

<hr>
<h2>similar posts</h2>
{% for post in similar_posts %}
    <a href="{{post.get_absolute_url}}">{{ post.caption | truncatewords:5 }}</a>
{% empty %}
    there are no same post
{% endfor %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    $(document).ready(function (){
        $('.like-button').click(function() {
            var post_id = $(this).closest('.post').data('post-id');
            var button = $(this);
            $.ajax({
                type: 'POST',
                url: '{% url 'Social:like_post' %}',
                data: {'post_id': post_id, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
                success: function(data){
                    if(data.liked) {
                        button.text('Unlike');
                        }
                    else {
                        button.text('Like');
                    }
                    {#$('.like-count').text(data.like_count);#}
                    button.closest('.post').find('.like-count').text(data.like_count);
                }
            })
        })

        $('.save-post').click(function() {
            var button = $(this);
            $.ajax({
                type: 'POST',
                url: '{% url 'Social:save_post' %}',
                data: {'post_id': {{ post.id }}, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
                success: function(data){
                    if(data.saved){
                    button.text('UnSave')}
                    else{
                        button.text('Save')
                    }
                },
                error:function(error){
                    console.log('error in ajax request', error);
                },
            });
        });
        $('.comment-form').submit(function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');

        $.ajax({
            type: 'POST',
            url: url,
            data: form.serialize(),
            dataType: 'json',
            success: function(data) {
                if (data.success) {
                    // اضافه کردن کامنت جدید به لیست
                    $('.comment-list').append(
                        '<p style="background: lightseagreen; color: indigo">'
                        + data.author + ': ' + data.text + '</p>'
                    );
                    // فرم رو خالی می‌کنیم
                    form[0].reset();
                    // ارورها رو خالی می‌کنیم
                    $('.comment-errors').empty();
                }
            },
            error: function(xhr) {
                // ارورهای فرم رو نشون می‌ده
                if (xhr.responseJSON && xhr.responseJSON.errors) {
                    var errors = xhr.responseJSON.errors;
                    var errorHtml = '';
                    for (var field in errors) {
                        errorHtml += errors[field].join('<br>') + '<br>';
                    }
                    $('.comment-errors').html(errorHtml);
                } else {
                    $('.comment-errors').html('An error occurred.');
                }
            }
        });
    });
    })
</script>